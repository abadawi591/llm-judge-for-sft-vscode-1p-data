// =============================================================================
// VERIFY: Is system prompt included in promptTokens?
// =============================================================================
// METHOD: Look at the FIRST LLM call of Turn 1 (no tools, no history yet)
//
// At Turn 1, Call 1:
//   promptTokens = system_prompt + tool_definitions + user_message
//
// If system prompt is included, first call should be ~8,000-15,000 tokens
// (system prompts are typically 2,000-5,000 tokens, tools can be 5,000-10,000)
// =============================================================================

let timeStart = ago(24h);
let timeEnd = now();

// Find Turn 1 data
let turn1Data = 
    AppEvents
    | where TimeGenerated > timeStart and TimeGenerated <= timeEnd
    | where Name == "GitHub.copilot-chat/toolCallDetailsInternal"
    | extend messageId = tostring(Properties["messageId"])
    | extend turnIndex = toint(Measurements["turnIndex"])
    | extend numRequests = toint(Measurements["numRequests"])
    | extend responseType = tostring(Properties["responseType"])
    | where responseType == "success"
    | where turnIndex == 1  // First turn only
    | project messageId, turnIndex, numRequests;

// Get the FIRST LLM call for each Turn 1
let firstCallTokens = 
    AppEvents
    | where TimeGenerated > timeStart and TimeGenerated <= timeEnd
    | where Name == "GitHub.copilot-chat/engine.messages.length"
    | extend message_direction = tostring(Properties["message_direction"])
    | where message_direction == "output"
    | extend messageId = tostring(Properties["headerRequestId"])
    | extend promptTokens = toint(Measurements["promptTokens"])
    | summarize firstCallPromptTokens = min(promptTokens) by messageId;

// Join and analyze
turn1Data
| join kind=inner firstCallTokens on messageId
| summarize 
    count = count(),
    avgFirstCallTokens = avg(firstCallPromptTokens),
    minFirstCallTokens = min(firstCallPromptTokens),
    maxFirstCallTokens = max(firstCallPromptTokens),
    p10 = percentile(firstCallPromptTokens, 10),
    p50 = percentile(firstCallPromptTokens, 50),
    p90 = percentile(firstCallPromptTokens, 90)

// =============================================================================
// EXPECTED OUTPUT:
// If system prompt IS included:
//   avgFirstCallTokens ≈ 8,000 - 15,000 (system + tools + short user message)
//   Consistent across conversations (similar base context)
//
// If system prompt NOT included:
//   avgFirstCallTokens ≈ 100 - 500 (just user message)
//   Would vary wildly based on user message length
// =============================================================================

