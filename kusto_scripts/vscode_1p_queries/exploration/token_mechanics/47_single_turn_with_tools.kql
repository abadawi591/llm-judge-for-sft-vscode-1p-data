// =============================================================================
// SINGLE TURN WITH TOOLS - Direct MessageId Query (No Expensive Joins)
// =============================================================================
// Uses a specific messageId to avoid memory issues
// Replace the messageId with one from your data that has tool usage
// =============================================================================

// CHANGE THIS to a messageId with tool usage from your data
// Example from earlier: "710f5792-1e24-400c-bd63-f04ddffae0a9" had 9 requests
let targetMessageId = "710f5792-1e24-400c-bd63-f04ddffae0a9";

let timeStart = ago(24h);

// Step 1: Get OUTPUT events (actual API tokens)
let outputEvents = 
    AppEvents
    | where TimeGenerated > timeStart
    | where Name == "GitHub.copilot-chat/engine.messages.length"
    | extend message_direction = tostring(Properties["message_direction"])
    | where message_direction == "output"
    | extend messageId = tostring(Properties["headerRequestId"])
    | where messageId == targetMessageId  // Direct filter, no join!
    | extend promptTokens = toint(Measurements["promptTokens"])
    | extend completionTokens = toint(Measurements["completionTokens"])
    | extend model = tostring(Properties["baseModel"])
    | project messageId, promptTokens, completionTokens, model, TimeGenerated
    | order by TimeGenerated asc
    | extend callIndex = row_number();

// Step 2: Get INPUT events (trajectory breakdown)
let inputEvents = 
    AppEvents
    | where TimeGenerated > timeStart
    | where Name == "GitHub.copilot-chat/engine.messages.length"
    | extend message_direction = tostring(Properties["message_direction"])
    | where message_direction == "input"
    | extend messageId = tostring(Properties["headerRequestId"])
    | where messageId == targetMessageId  // Direct filter, no join!
    | extend messagesJsonStr = tostring(Properties["messagesJson"])
    | where isnotempty(messagesJsonStr)
    | project messageId, messagesJsonStr, TimeGenerated
    | order by TimeGenerated asc
    | extend callIndex = row_number();

// Step 3: Parse trajectory per call
let trajectoryParsed = 
    inputEvents
    | mv-expand message = parse_json(messagesJsonStr)
    | extend role = tostring(message.role)
    | extend tokenCount = toint(message.content)
    | summarize 
        systemTokens = sumif(tokenCount, role == "system"),
        userTokens = sumif(tokenCount, role == "user"),
        assistantTokens = sumif(tokenCount, role == "assistant"),
        toolResultTokens = sumif(tokenCount, role == "tool"),
        trajectoryTotal = sum(tokenCount)
        by messageId, callIndex;

// Step 4: Join on callIndex
outputEvents
| join kind=leftouter trajectoryParsed on messageId, callIndex
| project 
    callIndex,
    model,
    // Actual API tokens
    promptTokens,
    completionTokens,
    // Role breakdown
    hasTrajectory = isnotnull(trajectoryTotal) and trajectoryTotal > 0,
    systemTokens = coalesce(systemTokens, 0),
    userTokens = coalesce(userTokens, 0),
    assistantTokens = coalesce(assistantTokens, 0),
    toolResultTokens = coalesce(toolResultTokens, 0),
    trajectoryTotal = coalesce(trajectoryTotal, 0)
| order by callIndex asc

// =============================================================================
// To find a messageId with tool usage, run this query first:
// =============================================================================
/*
AppEvents
| where TimeGenerated > ago(1h)
| where Name == "GitHub.copilot-chat/toolCallDetailsInternal"
| extend messageId = tostring(Properties["messageId"])
| extend numRequests = toint(Measurements["numRequests"])
| extend toolCounts = tostring(Properties["toolCounts"])
| extend responseType = tostring(Properties["responseType"])
| where responseType == "success"
| where numRequests >= 3  // At least 2 tool calls + 1 final
| project messageId, numRequests, toolCounts
| take 5
*/

